<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Test Browser Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding: 20px; }
        .log-box { background: #1a1a1a; color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; word-break: break-all; font-size: 0.9rem; max-height: 500px; overflow-y: auto; margin: 15px 0; }
        .success { color: #10b981; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Automated Synchronization Test</h1>
        <p>This test runs automatically and simulates the complete vet registration and display flow.</p>

        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3>üìã Test Output</h3>
            <div class="log-box" id="output">Initializing tests...</div>

            <div id="results" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // Include rdv.js content
        const defaultVets = [
          { id: 1, name: "Dr. Ahmed Alami", city: "Casablanca", specialty: "G√©n√©raliste", phone: "+212 5 22 34 56 78", email: "ahmed@vets.ma", rating: 4.8, reviews: 156, experience: 15, image: "ü©∫", color: "#f59e0b" },
          { id: 2, name: "Dr. Fatima Bennani", city: "Rabat", specialty: "Dermatologie", phone: "+212 5 37 12 34 56", email: "fatima@vets.ma", rating: 4.9, reviews: 203, experience: 12, image: "üíä", color: "#10b981" },
          { id: 3, name: "Dr. Mohamed Karim", city: "F√®s", specialty: "Chirurgie", phone: "+212 5 35 63 74 85", email: "karim@vets.ma", rating: 4.7, reviews: 189, experience: 18, image: "‚öïÔ∏è", color: "#3b82f6" },
          { id: 4, name: "Dr. Leila Hamdaoui", city: "Marrakech", specialty: "Dentaire", phone: "+212 5 24 45 56 67", email: "leila@vets.ma", rating: 4.9, reviews: 234, experience: 14, image: "ü¶∑", color: "#ec4899" }
        ];

        let vets = [];
        const output = document.getElementById('output');
        const results = document.getElementById('results');
        let testsPassed = 0;
        let testsFailed = 0;

        function log(text) {
            output.textContent += text + '\n';
            output.scrollTop = output.scrollHeight;
        }

        function test(name, condition) {
            if (condition) {
                log(`<span class="success">‚úÖ PASS: ${name}</span>`);
                testsPassed++;
            } else {
                log(`<span class="error">‚ùå FAIL: ${name}</span>`);
                testsFailed++;
            }
        }

        // AUTO-RUN TESTS
        window.addEventListener('load', () => {
            log('üöÄ STARTING AUTOMATED TESTS\n');
            log('='.repeat(60) + '\n');

            // TEST 1: Registration
            log('üìã TEST 1: Vet Registration & Sync\n');
            localStorage.clear();

            const vetProfile = {
                id: Date.now().toString(),
                name: 'Dr. Test Browser Auto',
                email: 'test.auto@example.com',
                specialty: 'Chirurgie',
                phone: '06-99-88-77-66',
                city: 'Casablanca'
            };

            log('  Creating: ' + vetProfile.name);

            const existingVets = JSON.parse(localStorage.getItem('ph_vet_profiles') || '[]');
            existingVets.push(vetProfile);
            localStorage.setItem('ph_vet_profiles', JSON.stringify(existingVets));
            test('ph_vet_profiles saved', existingVets.length === 1);

            const clientVetsList = JSON.parse(localStorage.getItem('ph_vet_list') || '[]');
            const vetForClients = {
                id: vetProfile.id,
                name: vetProfile.name,
                email: vetProfile.email,
                city: vetProfile.city,
                specialty: vetProfile.specialty,
                phone: vetProfile.phone,
                rating: 5.0,
                reviews: 0,
                isRegistered: true,
                registeredAt: new Date().toISOString()
            };
            clientVetsList.push(vetForClients);
            localStorage.setItem('ph_vet_list', JSON.stringify(clientVetsList));
            test('ph_vet_list synced', clientVetsList.length === 1);

            log('');

            // TEST 2: Verify Data
            log('üîç TEST 2: Verify localStorage Data\n');
            const savedProfiles = JSON.parse(localStorage.getItem('ph_vet_profiles') || '[]');
            const savedList = JSON.parse(localStorage.getItem('ph_vet_list') || '[]');
            test('ph_vet_profiles contains data', savedProfiles.length > 0);
            test('ph_vet_list contains data', savedList.length > 0);
            test('Email matches', savedList[0].email === vetProfile.email);

            log('');

            // TEST 3: Load All Vets
            log('‚öôÔ∏è  TEST 3: Load All Vets (loadAllVetsForRDV)\n');
            vets = [...defaultVets];
            test('Default vets loaded', vets.length === 4);

            const registeredVets = JSON.parse(localStorage.getItem('ph_vet_list') || '[]');
            registeredVets.forEach(regVet => {
                const alreadyExists = vets.find(v => v.email === regVet.email);
                if (!alreadyExists) {
                    const transformedVet = {
                        id: regVet.id || Date.now(),
                        name: regVet.name,
                        city: regVet.city || 'Non sp√©cifi√©',
                        specialty: regVet.specialty || 'G√©n√©raliste',
                        phone: regVet.phone || '',
                        email: regVet.email,
                        rating: regVet.rating || 5.0,
                        reviews: regVet.reviews || 0,
                        experience: 0,
                        image: "üè•",
                        color: "#ef4444",
                        isNewRegistered: true
                    };
                    vets.push(transformedVet);
                }
            });
            test('Registered vets added', vets.length === 5);
            test('New vet has isNewRegistered flag', vets.some(v => v.isNewRegistered));

            log('');

            // TEST 4: Display Vets
            log('üé® TEST 4: Display Vets (displayVets)\n');
            test('vets array not empty', vets.length > 0);
            test('Would render 5 cards', vets.length === 5);
            test('Newly registered vet in array', vets.filter(v => v.name === vetProfile.name).length === 1);

            const newVet = vets.find(v => v.name === vetProfile.name);
            test('New vet has correct specialty', newVet.specialty === vetProfile.specialty);
            test('New vet has correct city', newVet.city === vetProfile.city);

            log('');
            log('='.repeat(60));
            log('');

            // SUMMARY
            const passed = `<span class="success">${testsPassed} PASSED</span>`;
            const failed = testsFailed > 0 ? `<span class="error">${testsFailed} FAILED</span>` : '';
            log(`\nüìä RESULTS: ${passed}${failed ? ' / ' + failed : ''}`);

            if (testsFailed === 0) {
                log('\n<span class="success">‚úÖ ALL TESTS PASSED! THE SYSTEM WORKS CORRECTLY!</span>');
                results.innerHTML = `
                    <div class="alert alert-success">
                        <h4>‚úÖ TEST SUITE PASSED</h4>
                        <p>The veterinarian synchronization system works perfectly:</p>
                        <ul>
                            <li>‚úÖ Vet registration saves correctly</li>
                            <li>‚úÖ Synchronization to client list works</li>
                            <li>‚úÖ loadAllVetsForRDV() loads all vets including new ones</li>
                            <li>‚úÖ Newly registered vets would display in rdv.html</li>
                        </ul>
                        <p><strong>The logic is correct. If you're not seeing vets in rdv.html, check:</strong></p>
                        <ul>
                            <li>Are you actually registering a vet in home.html?</li>
                            <li>Is #vetsContainer visible in the "V√©t√©rinaires Partenaires" tab?</li>
                            <li>Check browser console (F12) for any errors</li>
                        </ul>
                    </div>
                `;
            } else {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>‚ùå TESTS FAILED</h4>
                        <p>There are issues with the synchronization system. See logs above.</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
