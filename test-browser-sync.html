<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Browser Synchronization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding: 20px; }
        .test-card { margin: 20px 0; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .log-box { background: #1a1a1a; color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; word-break: break-all; font-size: 0.85rem; max-height: 400px; overflow-y: auto; margin: 15px 0; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        button { margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Browser Synchronization Test</h1>

        <!-- TEST 1: Registration -->
        <div class="test-card">
            <h3>Test 1: Simulating Vet Registration</h3>
            <button class="btn btn-primary" onclick="testRegistration()">Run Registration Test</button>
            <div class="log-box" id="log1">Waiting...</div>
        </div>

        <!-- TEST 2: Verify Data -->
        <div class="test-card">
            <h3>Test 2: Verify localStorage Data</h3>
            <button class="btn btn-info" onclick="testVerifyData()">Verify Data</button>
            <div class="log-box" id="log2">Waiting...</div>
        </div>

        <!-- TEST 3: Load All Vets -->
        <div class="test-card">
            <h3>Test 3: Load All Vets (RDV Page)</h3>
            <button class="btn btn-success" onclick="testLoadAllVets()">Load All Vets</button>
            <div class="log-box" id="log3">Waiting...</div>
        </div>

        <!-- TEST 4: Display Vets -->
        <div class="test-card">
            <h3>Test 4: Display Vets</h3>
            <div id="displayContainer" style="background: #f0f0f0; padding: 15px; border-radius: 8px; min-height: 100px;"></div>
            <button class="btn btn-warning" onclick="testDisplayVets()">Display Vets</button>
        </div>

        <!-- SUMMARY -->
        <div class="test-card">
            <h3>üìä Summary</h3>
            <div id="summary">Click buttons to run tests...</div>
        </div>
    </div>

    <script>
        // Include rdv.js content
        const defaultVets = [
          {
            id: 1,
            name: "Dr. Ahmed Alami",
            city: "Casablanca",
            specialty: "G√©n√©raliste",
            phone: "+212 5 22 34 56 78",
            email: "ahmed@vets.ma",
            rating: 4.8,
            reviews: 156,
            experience: 15,
            image: "ü©∫",
            availability: ["09:00", "10:00", "11:00", "14:00", "15:00", "16:00"],
            color: "#f59e0b"
          },
          {
            id: 2,
            name: "Dr. Fatima Bennani",
            city: "Rabat",
            specialty: "Dermatologie",
            phone: "+212 5 37 12 34 56",
            email: "fatima@vets.ma",
            rating: 4.9,
            reviews: 203,
            experience: 12,
            image: "üíä",
            availability: ["09:00", "10:00", "14:00", "15:00", "16:00", "17:00"],
            color: "#10b981"
          },
          {
            id: 3,
            name: "Dr. Mohamed Karim",
            city: "F√®s",
            specialty: "Chirurgie",
            phone: "+212 5 35 63 74 85",
            email: "karim@vets.ma",
            rating: 4.7,
            reviews: 189,
            experience: 18,
            image: "‚öïÔ∏è",
            availability: ["09:00", "10:00", "11:00", "14:00", "15:00", "16:00"],
            color: "#3b82f6"
          },
          {
            id: 4,
            name: "Dr. Leila Hamdaoui",
            city: "Marrakech",
            specialty: "Dentaire",
            phone: "+212 5 24 45 56 67",
            email: "leila@vets.ma",
            rating: 4.9,
            reviews: 234,
            experience: 14,
            image: "ü¶∑",
            availability: ["09:00", "10:00", "14:00", "15:00", "16:00"],
            color: "#ec4899"
          }
        ];

        let vets = [];

        function log(logId, text) {
            const el = document.getElementById(logId);
            if (el.textContent === 'Waiting...') el.textContent = '';
            el.textContent += (el.textContent ? '\n' : '') + text;
        }

        function testRegistration() {
            log('log1', 'üöÄ [TEST 1] Starting registration test...\n');
            
            // Clear old data
            localStorage.clear();
            
            const vetProfile = {
                id: Date.now().toString(),
                name: 'Dr. Test Browser',
                email: 'test.browser@example.com',
                password: btoa('test123'),
                specialty: 'Chirurgie',
                phone: '06-12-34-56-78',
                city: 'Casablanca',
                license: 'TEST-001',
                createdAt: new Date().toISOString(),
                appointments: []
            };

            log('log1', '‚úèÔ∏è  Creating vet: ' + vetProfile.name);

            // Save to ph_vet_profiles
            const existingVets = JSON.parse(localStorage.getItem('ph_vet_profiles') || '[]');
            existingVets.push(vetProfile);
            localStorage.setItem('ph_vet_profiles', JSON.stringify(existingVets));
            log('log1', '‚úÖ Saved to ph_vet_profiles');

            // Sync to ph_vet_list
            const clientVetsList = JSON.parse(localStorage.getItem('ph_vet_list') || '[]');
            const vetForClients = {
                id: vetProfile.id,
                name: vetProfile.name,
                email: vetProfile.email,
                city: vetProfile.city,
                specialty: vetProfile.specialty,
                phone: vetProfile.phone,
                rating: 5.0,
                reviews: 0,
                isRegistered: true,
                registeredAt: new Date().toISOString()
            };
            clientVetsList.push(vetForClients);
            localStorage.setItem('ph_vet_list', JSON.stringify(clientVetsList));
            log('log1', '‚úÖ Synced to ph_vet_list\n‚úÖ TEST PASSED');
        }

        function testVerifyData() {
            log('log2', 'üîç [TEST 2] Verifying data...\n');
            
            const vetProfiles = JSON.parse(localStorage.getItem('ph_vet_profiles') || '[]');
            const vetList = JSON.parse(localStorage.getItem('ph_vet_list') || '[]');

            log('log2', 'üìã ph_vet_profiles: ' + vetProfiles.length + ' vets');
            vetProfiles.forEach(v => {
                log('log2', '  ‚Ä¢ ' + v.name + ' (' + v.email + ')');
            });

            log('log2', '\nüìã ph_vet_list: ' + vetList.length + ' vets');
            vetList.forEach(v => {
                log('log2', '  ‚Ä¢ ' + v.name + ' (' + v.specialty + ')');
            });

            if (vetList.length > 0) {
                log('log2', '\n‚úÖ TEST PASSED - Data exists in ph_vet_list');
            } else {
                log('log2', '\n‚ùå TEST FAILED - ph_vet_list is empty!');
            }
        }

        function testLoadAllVets() {
            log('log3', '‚öôÔ∏è  [TEST 3] Loading all vets...\n');

            // Start with defaults
            vets = [...defaultVets];
            log('log3', '‚úÖ Loaded defaults: ' + vets.length + ' vets');

            // Load registered
            const registeredVets = JSON.parse(localStorage.getItem('ph_vet_list') || '[]');
            log('log3', '‚úÖ Loaded registered: ' + registeredVets.length + ' vets');

            // Transform and add
            registeredVets.forEach(regVet => {
                const alreadyExists = vets.find(v => v.email === regVet.email);
                if (alreadyExists) {
                    log('log3', '‚ö†Ô∏è  Skipping (already exists): ' + regVet.name);
                    return;
                }

                const transformedVet = {
                    id: regVet.id || Date.now(),
                    name: regVet.name,
                    city: regVet.city || 'Non sp√©cifi√©',
                    specialty: regVet.specialty || 'G√©n√©raliste',
                    phone: regVet.phone || '',
                    email: regVet.email,
                    rating: regVet.rating || 5.0,
                    reviews: regVet.reviews || 0,
                    experience: 0,
                    image: "üè•",
                    availability: ["09:00", "10:00", "11:00", "14:00", "15:00", "16:00"],
                    color: "#ef4444",
                    isNewRegistered: true
                };

                log('log3', '‚ûï Added registered vet: ' + transformedVet.name);
                vets.push(transformedVet);
            });

            log('log3', '\n‚úÖ Final vets array: ' + vets.length + ' vets');
            if (vets.length > 4) {
                log('log3', '‚úÖ TEST PASSED - Registered vets loaded');
            } else {
                log('log3', '‚ùå TEST FAILED - No registered vets in array');
            }
        }

        function testDisplayVets() {
            if (vets.length === 0) {
                document.getElementById('displayContainer').innerHTML = '<p class="error">‚ùå vets array is empty! Run Test 3 first!</p>';
                return;
            }

            const container = document.getElementById('displayContainer');
            container.innerHTML = vets.map(vet => `
                <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid ${vet.color};">
                    <strong>${vet.image} ${vet.name}</strong> 
                    ${vet.isNewRegistered ? '<span style="color: #10b981; font-weight: bold;">üÜï NEW</span>' : ''}
                    <br>
                    <small>${vet.specialty} | ${vet.city}</small>
                </div>
            `).join('');

            document.getElementById('summary').innerHTML = `
                <p><strong>‚úÖ Tests Summary:</strong></p>
                <ul>
                    <li>Total vets displayed: <strong>${vets.length}</strong></li>
                    <li>Registered vets: <strong>${vets.filter(v => v.isNewRegistered).length}</strong></li>
                    <li>Default vets: <strong>${vets.filter(v => !v.isNewRegistered).length}</strong></li>
                </ul>
                <p><strong>Result:</strong> <span class="success">‚úÖ ALL TESTS PASSED!</span></p>
            `;
        }
    </script>
</body>
</html>
